'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.receiveMapConfigUpdater = exports.loadMapStyleErrUpdater = exports.loadMapStylesUpdater = exports.mapBuildingChangeUpdater = exports.mapStyleChangeUpdater = exports.mapConfigChangeUpdater = undefined;

var _defineProperty2 = require('babel-runtime/helpers/defineProperty');

var _defineProperty3 = _interopRequireDefault(_defineProperty2);

var _extends3 = require('babel-runtime/helpers/extends');

var _extends4 = _interopRequireDefault(_extends3);

var _immutable = require('immutable');

var _immutable2 = _interopRequireDefault(_immutable);

var _d3Color = require('d3-color');

var _mapboxGlStyleEditor = require('../utils/map-style-utils/mapbox-gl-style-editor');

var _defaultSettings = require('../constants/default-settings');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Create two map styles from preset map style, one for top map one for bottom
 *
 * @param {string} styleType - current map style
 * @param {object} visibleLayerGroups - visible layers of bottom map
 * @param {object} topLayerGroups - visible layers of top map
 * @param {object} mapStyles - a dictionary of all map styles
 * @returns {object} bottomMapStyle | topMapStyle | isRaster
 */


// Utils
function getMapStyles(_ref) {
  var styleType = _ref.styleType,
      visibleLayerGroups = _ref.visibleLayerGroups,
      topLayerGroups = _ref.topLayerGroups,
      mapStyles = _ref.mapStyles;

  var mapStyle = mapStyles[styleType] && mapStyles[styleType];
  if (!mapStyle.style) {
    return {};
  }

  var editable = Object.keys(visibleLayerGroups).length;

  var bottomMapStyle = !editable ? _immutable2.default.fromJS(mapStyle.style) : (0, _mapboxGlStyleEditor.editBottomMapStyle)({
    id: styleType,
    mapStyle: mapStyle,
    visibleLayerGroups: visibleLayerGroups
  });

  var hasTopLayer = editable && Object.values(topLayerGroups).some(function (v) {
    return v;
  });

  // mute top layer if not visible in bottom layer
  var topLayers = hasTopLayer && Object.keys(topLayerGroups).reduce(function (accu, key) {
    return (0, _extends4.default)({}, accu, (0, _defineProperty3.default)({}, key, topLayerGroups[key] && visibleLayerGroups[key]));
  }, {});

  var topMapStyle = hasTopLayer ? (0, _mapboxGlStyleEditor.editTopMapStyle)({
    id: styleType,
    mapStyle: mapStyle,
    visibleLayerGroups: topLayers
  }) : null;

  return { bottomMapStyle: bottomMapStyle, topMapStyle: topMapStyle, editable: editable };
}

function getBuildingColor(style) {
  var bldgFillLayer = (style.style.layers || []).find(function (_ref2) {
    var id = _ref2.id;
    return id === 'building-fill';
  });

  var buildingColor = bldgFillLayer ? bldgFillLayer.paint['fill-color'] : _defaultSettings.DEFAULT_BLDG_COLOR;

  // brighten or darken building based on style
  var operation = style.id.match(/(?=(dark|night))/) ? 'brighter' : 'darker';
  var adjusted = (0, _d3Color.rgb)(buildingColor)[operation](0.2);
  return [Math.round(adjusted.r), Math.round(adjusted.g), Math.round(adjusted.b)];
}

// Updaters
var mapConfigChangeUpdater = exports.mapConfigChangeUpdater = function mapConfigChangeUpdater(state, action) {
  return (0, _extends4.default)({}, state, action.payload, getMapStyles((0, _extends4.default)({}, state, action.payload)));
};

var mapStyleChangeUpdater = exports.mapStyleChangeUpdater = function mapStyleChangeUpdater(state, _ref3) {
  var styleType = _ref3.payload;

  var visibleLayerGroups = (0, _mapboxGlStyleEditor.getDefaultLayerGroupVisibility)(state.mapStyles[styleType]);

  return (0, _extends4.default)({}, state, {
    styleType: styleType,
    visibleLayerGroups: visibleLayerGroups
  }, getMapStyles((0, _extends4.default)({}, state, {
    visibleLayerGroups: visibleLayerGroups,
    styleType: styleType
  })), {
    buildingLayer: (0, _extends4.default)({}, state.buildingLayer, {
      color: state.mapStyles[styleType].buildingColor
    })
  });
};

var mapBuildingChangeUpdater = exports.mapBuildingChangeUpdater = function mapBuildingChangeUpdater(state, _ref4) {
  var payload = _ref4.payload;
  return (0, _extends4.default)({}, state, {
    buildingLayer: (0, _extends4.default)({}, state.buildingLayer, payload)
  });
};

var loadMapStylesUpdater = exports.loadMapStylesUpdater = function loadMapStylesUpdater(state, action) {
  var newStyles = action.payload;
  Object.keys(newStyles).forEach(function (key) {
    var style = newStyles[key];

    // get building color
    newStyles[key] = (0, _extends4.default)({}, style, {
      buildingColor: getBuildingColor(style)
    });
  });

  // add new styles to state
  var newState = (0, _extends4.default)({}, state, {
    mapStyles: (0, _extends4.default)({}, state.mapStyles, newStyles)
  });

  return newStyles[state.styleType] ? mapStyleChangeUpdater(newState, { payload: state.styleType }) : newState;
};

// do nothing for now, if didn't load, skip it
var loadMapStyleErrUpdater = exports.loadMapStyleErrUpdater = function loadMapStyleErrUpdater(state, action) {
  return state;
};
var receiveMapConfigUpdater = exports.receiveMapConfigUpdater = function receiveMapConfigUpdater(state, action) {
  return action.payload.mapStyle ? mapConfigChangeUpdater(state, { payload: action.payload.mapStyle }) : state;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWR1Y2Vycy9tYXAtc3R5bGUtdXBkYXRlcnMuanMiXSwibmFtZXMiOlsiZ2V0TWFwU3R5bGVzIiwic3R5bGVUeXBlIiwidmlzaWJsZUxheWVyR3JvdXBzIiwidG9wTGF5ZXJHcm91cHMiLCJtYXBTdHlsZXMiLCJtYXBTdHlsZSIsInN0eWxlIiwiZWRpdGFibGUiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiYm90dG9tTWFwU3R5bGUiLCJmcm9tSlMiLCJpZCIsImhhc1RvcExheWVyIiwidmFsdWVzIiwic29tZSIsInYiLCJ0b3BMYXllcnMiLCJyZWR1Y2UiLCJhY2N1Iiwia2V5IiwidG9wTWFwU3R5bGUiLCJnZXRCdWlsZGluZ0NvbG9yIiwiYmxkZ0ZpbGxMYXllciIsImxheWVycyIsImZpbmQiLCJidWlsZGluZ0NvbG9yIiwicGFpbnQiLCJvcGVyYXRpb24iLCJtYXRjaCIsImFkanVzdGVkIiwiTWF0aCIsInJvdW5kIiwiciIsImciLCJiIiwibWFwQ29uZmlnQ2hhbmdlVXBkYXRlciIsInN0YXRlIiwiYWN0aW9uIiwicGF5bG9hZCIsIm1hcFN0eWxlQ2hhbmdlVXBkYXRlciIsImJ1aWxkaW5nTGF5ZXIiLCJjb2xvciIsIm1hcEJ1aWxkaW5nQ2hhbmdlVXBkYXRlciIsImxvYWRNYXBTdHlsZXNVcGRhdGVyIiwibmV3U3R5bGVzIiwiZm9yRWFjaCIsIm5ld1N0YXRlIiwibG9hZE1hcFN0eWxlRXJyVXBkYXRlciIsInJlY2VpdmVNYXBDb25maWdVcGRhdGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUdBOztBQUtBOzs7O0FBRUE7Ozs7Ozs7Ozs7O0FBUkE7QUFpQkEsU0FBU0EsWUFBVCxPQUtHO0FBQUEsTUFKREMsU0FJQyxRQUpEQSxTQUlDO0FBQUEsTUFIREMsa0JBR0MsUUFIREEsa0JBR0M7QUFBQSxNQUZEQyxjQUVDLFFBRkRBLGNBRUM7QUFBQSxNQUREQyxTQUNDLFFBRERBLFNBQ0M7O0FB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IjpbImltcG9ydCBJbW11dGFibGUgZnJvbSAnaW1tdXRhYmxlJztcbmltcG9ydCB7cmdifSBmcm9tICdkMy1jb2xvcic7XG5cbi8vIFV0aWxzXG5pbXBvcnQge1xuICBnZXREZWZhdWx0TGF5ZXJHcm91cFZpc2liaWxpdHksXG4gIGVkaXRUb3BNYXBTdHlsZSxcbiAgZWRpdEJvdHRvbU1hcFN0eWxlXG59IGZyb20gJ3V0aWxzL21hcC1zdHlsZS11dGlscy9tYXBib3gtZ2wtc3R5bGUtZWRpdG9yJztcbmltcG9ydCB7REVGQVVMVF9CTERHX0NPTE9SfSBmcm9tICdjb25zdGFudHMvZGVmYXVsdC1zZXR0aW5ncyc7XG5cbi8qKlxuICogQ3JlYXRlIHR3byBtYXAgc3R5bGVzIGZyb20gcHJlc2V0IG1hcCBzdHlsZSwgb25lIGZvciB0b3AgbWFwIG9uZSBmb3IgYm90dG9tXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHN0eWxlVHlwZSAtIGN1cnJlbnQgbWFwIHN0eWxlXG4gKiBAcGFyYW0ge29iamVjdH0gdmlzaWJsZUxheWVyR3JvdXBzIC0gdmlzaWJsZSBsYXllcnMgb2YgYm90dG9tIG1hcFxuICogQHBhcmFtIHtvYmplY3R9IHRvcExheWVyR3JvdXBzIC0gdmlzaWJsZSBsYXllcnMgb2YgdG9wIG1hcFxuICogQHBhcmFtIHtvYmplY3R9IG1hcFN0eWxlcyAtIGEgZGljdGlvbmFyeSBvZiBhbGwgbWFwIHN0eWxlc1xuICogQHJldHVybnMge29iamVjdH0gYm90dG9tTWFwU3R5bGUgfCB0b3BNYXBTdHlsZSB8IGlzUmFzdGVyXG4gKi9cbmZ1bmN0aW9uIGdldE1hcFN0eWxlcyh7XG4gIHN0eWxlVHlwZSxcbiAgdmlzaWJsZUxheWVyR3JvdXBzLFxuICB0b3BMYXllckdyb3VwcyxcbiAgbWFwU3R5bGVzXG59KSB7XG4gIGNvbnN0IG1hcFN0eWxlID0gbWFwU3R5bGVzW3N0eWxlVHlwZV0gJiYgbWFwU3R5bGVzW3N0eWxlVHlwZV07XG4gIGlmICghbWFwU3R5bGUuc3R5bGUpIHtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBjb25zdCBlZGl0YWJsZSA9IE9iamVjdC5rZXlzKHZpc2libGVMYXllckdyb3VwcykubGVuZ3RoO1xuXG4gIGNvbnN0IGJvdHRvbU1hcFN0eWxlID0gIWVkaXRhYmxlXG4gICAgPyBJbW11dGFibGUuZnJvbUpTKG1hcFN0eWxlLnN0eWxlKVxuICAgIDogZWRpdEJvdHRvbU1hcFN0eWxlKHtcbiAgICAgICAgaWQ6IHN0eWxlVHlwZSxcbiAgICAgICAgbWFwU3R5bGUsXG4gICAgICAgIHZpc2libGVMYXllckdyb3Vwc1xuICAgICAgfSk7XG5cbiAgY29uc3QgaGFzVG9wTGF5ZXIgPSBlZGl0YWJsZSAmJiBPYmplY3QudmFsdWVzKHRvcExheWVyR3JvdXBzKS5zb21lKHYgPT4gdik7XG5cbiAgLy8gbXV0ZSB0b3AgbGF5ZXIgaWYgbm90IHZpc2libGUgaW4gYm90dG9tIGxheWVyXG4gIGNvbnN0IHRvcExheWVycyA9XG4gICAgaGFzVG9wTGF5ZXIgJiZcbiAgICBPYmplY3Qua2V5cyh0b3BMYXllckdyb3VwcykucmVkdWNlKFxuICAgICAgKGFjY3UsIGtleSkgPT4gKHtcbiAgICAgICAgLi4uYWNjdSxcbiAgICAgICAgW2tleV06IHRvcExheWVyR3JvdXBzW2tleV0gJiYgdmlzaWJsZUxheWVyR3JvdXBzW2tleV1cbiAgICAgIH0pLFxuICAgICAge31cbiAgICApO1xuXG4gIGNvbnN0IHRvcE1hcFN0eWxlID0gaGFzVG9wTGF5ZXJcbiAgICA/IGVkaXRUb3BNYXBTdHlsZSh7XG4gICAgICAgIGlkOiBzdHlsZVR5cGUsXG4gICAgICAgIG1hcFN0eWxlLFxuICAgICAgICB2aXNpYmxlTGF5ZXJHcm91cHM6IHRvcExheWVyc1xuICAgICAgfSlcbiAgICA6IG51bGw7XG5cbiAgcmV0dXJuIHtib3R0b21NYXBTdHlsZSwgdG9wTWFwU3R5bGUsIGVkaXRhYmxlfTtcbn1cblxuZnVuY3Rpb24gZ2V0QnVpbGRpbmdDb2xvcihzdHlsZSkge1xuICBjb25zdCBibGRnRmlsbExheWVyID0gKHN0eWxlLnN0eWxlLmxheWVycyB8fCBbXSkuZmluZChcbiAgICAoe2lkfSkgPT4gaWQgPT09ICdidWlsZGluZy1maWxsJ1xuICApO1xuXG4gIGNvbnN0IGJ1aWxkaW5nQ29sb3IgPSBibGRnRmlsbExheWVyXG4gICAgPyBibGRnRmlsbExheWVyLnBhaW50WydmaWxsLWNvbG9yJ11cbiAgICA6IERFRkFVTFRfQkxER19DT0xPUjtcblxuICAvLyBicmlnaHRlbiBvciBkYXJrZW4gYnVpbGRpbmcgYmFzZWQgb24gc3R5bGVcbiAgY29uc3Qgb3BlcmF0aW9uID0gc3R5bGUuaWQubWF0Y2goLyg/PShkYXJrfG5pZ2h0KSkvKSA/ICdicmlnaHRlcicgOiAnZGFya2VyJztcbiAgY29uc3QgYWRqdXN0ZWQgPSByZ2IoYnVpbGRpbmdDb2xvcilbb3BlcmF0aW9uXSgwLjIpO1xuICByZXR1cm4gW1xuICAgIE1hdGgucm91bmQoYWRqdXN0ZWQuciksXG4gICAgTWF0aC5yb3VuZChhZGp1c3RlZC5nKSxcbiAgICBNYXRoLnJvdW5kKGFkanVzdGVkLmIpXG4gIF07XG59XG5cbi8vIFVwZGF0ZXJzXG5leHBvcnQgY29uc3QgbWFwQ29uZmlnQ2hhbmdlVXBkYXRlciA9IChzdGF0ZSwgYWN0aW9uKSA9PiAoe1xuICAuLi5zdGF0ZSxcbiAgLi4uYWN0aW9uLnBheWxvYWQsXG4gIC4uLmdldE1hcFN0eWxlcyh7XG4gICAgLi4uc3RhdGUsXG4gICAgLi4uYWN0aW9uLnBheWxvYWRcbiAgfSlcbn0pO1xuXG5leHBvcnQgY29uc3QgbWFwU3R5bGVDaGFuZ2VVcGRhdGVyID0gKHN0YXRlLCB7cGF5bG9hZDogc3R5bGVUeXBlfSkgPT4ge1xuICBjb25zdCB2aXNpYmxlTGF5ZXJHcm91cHMgPSBnZXREZWZhdWx0TGF5ZXJHcm91cFZpc2liaWxpdHkoXG4gICAgc3RhdGUubWFwU3R5bGVzW3N0eWxlVHlwZV1cbiAgKTtcblxuICByZXR1cm4ge1xuICAgIC4uLnN0YXRlLFxuICAgIHN0eWxlVHlwZSxcbiAgICB2aXNpYmxlTGF5ZXJHcm91cHMsXG4gICAgLi4uZ2V0TWFwU3R5bGVzKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgdmlzaWJsZUxheWVyR3JvdXBzLFxuICAgICAgc3R5bGVUeXBlXG4gICAgfSksXG4gICAgYnVpbGRpbmdMYXllcjoge1xuICAgICAgLi4uc3RhdGUuYnVpbGRpbmdMYXllcixcbiAgICAgIGNvbG9yOiBzdGF0ZS5tYXBTdHlsZXNbc3R5bGVUeXBlXS5idWlsZGluZ0NvbG9yXG4gICAgfVxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IG1hcEJ1aWxkaW5nQ2hhbmdlVXBkYXRlciA9IChzdGF0ZSwge3BheWxvYWR9KSA9PiAoe1xuICAuLi5zdGF0ZSxcbiAgYnVpbGRpbmdMYXllcjoge1xuICAgIC4uLnN0YXRlLmJ1aWxkaW5nTGF5ZXIsXG4gICAgLi4ucGF5bG9hZFxuICB9XG59KTtcblxuZXhwb3J0IGNvbnN0IGxvYWRNYXBTdHlsZXNVcGRhdGVyID0gKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgY29uc3QgbmV3U3R5bGVzID0gYWN0aW9uLnBheWxvYWQ7XG4gIE9iamVjdC5rZXlzKG5ld1N0eWxlcykuZm9yRWFjaChrZXkgPT4ge1xuICAgIGNvbnN0IHN0eWxlID0gbmV3U3R5bGVzW2tleV07XG5cbiAgICAvLyBnZXQgYnVpbGRpbmcgY29sb3JcbiAgICBuZXdTdHlsZXNba2V5XSA9IHtcbiAgICAgIC4uLnN0eWxlLFxuICAgICAgYnVpbGRpbmdDb2xvcjogZ2V0QnVpbGRpbmdDb2xvcihzdHlsZSlcbiAgICB9O1xuICB9KTtcblxuICAvLyBhZGQgbmV3IHN0eWxlcyB0byBzdGF0ZVxuICBjb25zdCBuZXdTdGF0ZSA9IHtcbiAgICAuLi5zdGF0ZSxcbiAgICBtYXBTdHlsZXM6IHtcbiAgICAgIC4uLnN0YXRlLm1hcFN0eWxlcyxcbiAgICAgIC4uLm5ld1N0eWxlc1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gbmV3U3R5bGVzW3N0YXRlLnN0eWxlVHlwZV1cbiAgICA/IG1hcFN0eWxlQ2hhbmdlVXBkYXRlcihuZXdTdGF0ZSwge3BheWxvYWQ6IHN0YXRlLnN0eWxlVHlwZX0pXG4gICAgOiBuZXdTdGF0ZTtcbn07XG5cbi8vIGRvIG5vdGhpbmcgZm9yIG5vdywgaWYgZGlkbid0IGxvYWQsIHNraXAgaXRcbmV4cG9ydCBjb25zdCBsb2FkTWFwU3R5bGVFcnJVcGRhdGVyID0gKHN0YXRlLCBhY3Rpb24pID0+IHN0YXRlO1xuZXhwb3J0IGNvbnN0IHJlY2VpdmVNYXBDb25maWdVcGRhdGVyID0gKHN0YXRlLCBhY3Rpb24pID0+XG4gIGFjdGlvbi5wYXlsb2FkLm1hcFN0eWxlXG4gICAgPyBtYXBDb25maWdDaGFuZ2VVcGRhdGVyKHN0YXRlLCB7cGF5bG9hZDogYWN0aW9uLnBheWxvYWQubWFwU3R5bGV9KVxuICAgIDogc3RhdGU7XG4iXX0=